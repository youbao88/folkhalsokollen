<!DOCTYPE html>

<head>
    <title>
        linje_selector
    </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: Arial, Verdana, Helvetica;
            font-size: 0.9rem;
            background-color: transparent;
        }

        .selectorContainer {
            padding: 20px;
        }

        .selectorTextWrap {
            background-color: rgb(97, 35, 97);
            padding: 8px;
            margin-top: 13px;
            margin-bottom: 0px;
            width: 100%;
        }

        .selectorText {
            color: #FFFFFF;
            font-size: 12.0pt;
        }

        .selectorDropdown {
            background-color: #FFFFFF;
            margin-top: 0px;
            width: 100%;
            padding: 16px;
        }

        .mySelectpicker {
            margin: auto;
            border: 1px solid #b0b8bc;
            border-radius: 0;
            background-color: #FFFFFF;
        }

        .mySelectpicker:hover {
            background-color: #b0b8bc;
        }

        .hide {
            display: none;
        }

        .center {
            margin: auto !important;
        }

        .bootstrap-select .dropdown-menu {
            max-width: 100% !important;
        }

        .bootstrap-select .dropdown-menu li a {
            padding-left: 15px !important;
        }

        .bootstrap-select .dropdown-menu li a {
            padding-left: 15px !important;
        }

        .selected {
            font-weight: bold;
        }

        .check-mark {
            font-size: 0.8rem;
            vertical-align: middle;
        }
    </style>
</head>

<body>
    <div class="selectorContainer">
        <div class='selectorWrap'>
            <div class='selectorTextWrap'>
                <span class='selectorText'>4. Välj område</span>
            </div>
            <div class='selectorDropdown'>
                <select class="selectpicker" id='linje_omrade' multiple data-live-search="true"
                    data-style='mySelectpicker' data-width='100%' sas-parameter='linje_Område'
                    data-live-search-placeholder='Sök område'>
                </select>
            </div>
        </div>
        <div class='selectorWrap'>
            <div class='selectorTextWrap'>
                <span class='selectorText'>5. Välj kön</span>
            </div>
            <div class='selectorDropdown'>
                <select class="selectpicker" id='linje_kon' multiple data-style='mySelectpicker' data-width='100%'
                    data-actions-box="true" data-select-all-text='välj alla' sas-parameter='linje_Kön'>
                </select>
            </div>
        </div>
        <div class='selectorWrap'>
            <div class='selectorTextWrap'>
                <span class='selectorText'>6. Välj ålder</span>
            </div>
            <div class='selectorDropdown'>
                <select class="selectpicker" id='linje_alder' multiple data-style='mySelectpicker' data-width='100%'
                    data-actions-box="true" data-select-all-text='välj alla' sas-parameter='linje_Åldersgrupp'>
                </select>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
        integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous">
    </script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"
        integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous">
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
    <script>
        omradeSubTextMap = {
            "Botkyrka": "kommun",
            "Bromma": "stadsdel",
            "Danderyd": "kommun",
            "Ekerö": "kommun",
            "Enskede-Årsta-Vantör": "stadsdel",
            "Farsta": "stadsdel",
            "Haninge": "kommun",
            "Huddinge": "kommun",
            "Hägersten-Älvsjö": "stadsdel",
            "Hässelby-Vällingby": "stadsdel",
            "Järfälla": "kommun",
            "Kungsholmen": "stadsdel",
            "Lidingö": "kommun",
            "Nacka": "kommun",
            "Norrmalm": "stadsdel",
            "Norrtälje": "kommun",
            "Nykvarn": "kommun",
            "Nynäshamn": "kommun",
            "Rinkeby-Kista": "stadsdel",
            "Salem": "kommun",
            "Sigtuna": "kommun",
            "Skarpnäck": "stadsdel",
            "Skärholmen": "stadsdel",
            "Sollentuna": "kommun",
            "Solna": "kommun",
            "Spånga-Tensta": "stadsdel",
            "Stockholm": "kommun",
            "Stockholms län": "län",
            "Sundbyberg": "kommun",
            "Södermalm": "stadsdel",
            "Södertälje": "kommun",
            "Tyresö": "kommun",
            "Täby": "kommun",
            "Upplands Väsby": "kommun",
            "Upplands-Bro": "kommun",
            "Vallentuna": "kommun",
            "Vaxholm": "kommun",
            "Värmdö": "kommun",
            "Östermalm": "stadsdel",
            "Österåker": "kommun"
        };
        const allaOmrade = {
            'Stockholms län': [],
            'Stockholm': [],
            'Botkyrka': ['Alby',
                'Fittja',
                'Hallunda-Norsborg centrala',
                'Hallunda-Norsborg övr omr',
                'Storvreten',
                'Tumba övr',
                'Tullinge',
                'Grödinge/Vårsta'
            ],
            'Bromma': ['Abrahamsberg-Riksby-Åkeshov-Åkeslund',
                'Alvik-Smedslätten-Stora Mossen-Ulvsunda-Äppelviken',
                'Ålsten-Nockeby',
                'Bromma Kyrka-Ängby',
                'Beckomberga-Bällsta',
                'Mariehäll',
                'Traneberg-Ulvsunda Industriområde',
                'Blackeberg'
            ],
            'Danderyd': ['Enebyberg-Klingsta',
                'Mörby-Danderyds k:a',
                'Djursholm',
                'Stocksund'
            ],
            'Ekerö': ['Träkvista-Tappström', 'Ekerö övrigt'],
            'Enskede-Årsta-Vantör': ['Högdalen-Bandhagen',
                'Enskede',
                'Johanneshov',
                'Årsta',
                'Östberga-Valla Gärde',
                'Hagsätra',
                'Rågsved',
                'Stureby-Örby'
            ],
            'Farsta': ['Hökarängen-Fagersjö',
                'Farsta stadsdel',
                'Farsta strand-Larsboda',
                'Gubbängen-Tallkrogen-Svedmyra',
                'Sköndal'
            ],
            'Haninge': ['Vendelsö-Norrby',
                'Vendelsömalm-N Söderby',
                'Brandbergen',
                'Vega-Kolartorp',
                'Handen',
                'Jordbro',
                'Dalarö-Haninge glesbygd',
                'Västerhaninge',
                'Tungelsta'
            ],
            'Huddinge': ['Fullersta',
                'Sjödalen-Balingsnäs',
                'Stuvsta',
                'Skogås',
                'Trångsund',
                'Vårby-Masmo',
                'Segeltorp-Smista',
                'Snättringe-Glömsta',
                'Länna-Vidja',
                'Flemmingsberg'
            ],
            'Hägersten-Älvsjö': ['Gröndal',
                'Aspudden',
                'Liljeholmen',
                'Midsommarkransen-Västberga',
                'Solberga',
                'Älvsjö-Liseberg',
                'Herängen-Långbro',
                'Fruängen',
                'Mälarhöjden',
                'Västertorp',
                'Hägersten'
            ],
            'Hässelby-Vällingby': ['Hässelby Gård',
                'Hässelby Villastad',
                'Råcksta',
                'Kälvesta-Nälsta-Vinsta',
                'Grimsta-Vällingby',
                'Hässelby Strand'
            ],
            'Järfälla': ['Kallhäll omland',
                'Kallhäll',
                'Mellersta Järfälla',
                'Jakobsbergs C-Vibblaby',
                'Viksjö',
                'Veddesta',
                'Barkarby',
                'Tallbohov-Hammaren'
            ],
            'Kungsholmen': ['Kungsholm',
                'Östra S:t Göran',
                'Stadshagen',
                'Kristineberg-Marieberg',
                'Fredhäll-Essingen'
            ],
            'Lidingö': ['Larsberg-Baggeby-Bodal-Gångsätra',
                'Torsvik-Herserud-Hersby-Mosstorp',
                'Lidingö östra',
                'Lidingö nordväst'
            ],
            'Nacka': ['Älta',
                'Henriksdal-Jarlaberg',
                'Finntorp-Nysätra',
                'Nacka C-Jarlaberg-Nacka strand',
                'Ektorp-Skuru-Duvnäs',
                'Björknäs-Eknäs',
                'Orminge-Krokhöjden',
                'Kummelnäs-Mensättra',
                'Lännersta-Boo',
                'Fisksätra',
                'Saltsjöbaden'
            ],
            'Norrmalm': ['Norra Johannes',
                'Gustav Vasa',
                'Östra Matteus',
                'Västra Matteus',
                'Jakob-Klara-Adolf Fredrik-Södra Johannes'
            ],
            'Norrtälje': ['Norrtälje stad norra',
                'Norrtälje norra landsbygden',
                'Norrtälje södra landsbygden',
                'Norrtälje stad södra',
                'Rimbo-Gottröra-Finsta',
                'Hallstavik-Väddö'
            ],
            'Nykvarn': ['Nykvarn kommun'],
            'Nynäshamn': ['Nynäshamn stad med omland',
                'Nynäshamn kommun, västra',
                'Ösmo med omland'
            ],
            'Rinkeby-Kista': ['Rinkeby', 'Akalla', 'Husby', 'Kista'],
            'Salem': ['Rönninge', 'Salemstaden'],
            'Sigtuna': ['Märsta omland',
                'Norra Märsta',
                'Sigtuna kommundel',
                'Södra Märsta',
                'Valsta C-Norra'
            ],
            'Skarpnäck': ['Hammarbyhöjden',
                'Björkhagen-Kärrtorp-Enskededalen',
                'Bagarmossen',
                'Skarpnäck stadsdel'
            ],
            'Skärholmen': ['Bredäng', 'Skärholmen stadsdel', 'Sätra', 'Vårberg'],
            'Sollentuna': ['Rotebro',
                'Norrviken-Vaxmora-Viby',
                'Häggvik',
                'Edsberg',
                'Tureberg-Falkberget-Sjöberg',
                'Helenelund',
                'Bagarby-Sollentuna C'
            ],
            'Solna': ['Järva-Bagartorp',
                'Råsunda-Näckrosen',
                'Bergshamra-Ulriksdal',
                'Frösunda-Hagalund',
                'Huvudsta',
                'Centrala Solna'
            ],
            'Spånga-Tensta': ['Tensta', 'Lunda-Solhem', 'Bromsten-Flysta-Sundby'],
            'Sundbyberg': ['Lilla Alby-Bällstaån',
                'Centrala Sundbyberg',
                'Storskogen-Tule-Duvbo',
                'Hallonbergen-Ör',
                'Rissne',
                'Ursvik-Brotorp'
            ],
            'Södermalm': ['Mariatorget-Södra station',
                'Södra Högalid',
                'Norra Högalid',
                'Sofia',
                'Östra Katarina-Gamla stan',
                'Södra Hammarbyhamnen',
                'Västra Katarina'
            ],
            'Södertälje': ['Södertälje stad centrala',
                'Södertälje stad västra',
                'Hovsjö-Saltskog-Södra',
                'Järna-Pershagen',
                'Brunnsäng-Grusåsen',
                'Södertälje kommun norra',
                'Rosenlund-Östertälje',
                'Fornhöjden-Glasberga',
                'Ronna-Lina Hage',
                'Geneta',
                'Hölö-Mölnbo'
            ],
            'Tyresö': ['Trollbäcken-Lindalen',
                'Bollmora västra',
                'Tyresö östra',
                'Bollmora östra-Krusboda'
            ],
            'Täby': ['Lahäll-Näsbypark',
                'Centrala Täby',
                'Viggbyholm-Hägernäs',
                'Gribbylund-Arninge-Täby glesbygd',
                'Ensta-Ella-Visinge',
                'Roslags-Näsby-Ella gård-Skarpäng',
                'Täby Kyrkby'
            ],
            'Upplands Väsby': ['Runby-Eds glesbygd',
                'Stora Väsby',
                'Väsby C-Smedby',
                'Odenslunda-Skälby-Frestaby',
                'Bollstanäs-Fresta glesbygd'
            ],
            'Upplands-Bro': ['Bro tätort', 'Brunna-Upplands Bro norra', 'Kungsängen'],
            'Vallentuna': ['Vallentuna-Ormsta', 'Bällsta', 'Vallentuna landsbygd'],
            'Vaxholm': ['Vaxolm'],
            'Värmdö': ['Mörtnäs-Hemmesta',
                'Gustavsberg',
                'Ingarö',
                'Värmdölandet-Djurö-Skärgården'
            ],
            'Östermalm': ['Engelbrekts k:a',
                'Hedvig Eleonora',
                'Oscars k:a',
                'Gärdet-Djurgården',
                'Tekniska Högskolan-Universitetet',
                'Hjorthagen-Värtahamnen'
            ],
            'Österåker': ['Österåker Nordost',
                'Åkersberga-Österskär',
                'Österåker Syd',
                'Österåker Väst'
            ]
        }

        $('.selectpicker').selectpicker();
        $('.bs-deselect-all').addClass('hide');
        $('.bs-select-all').addClass('center');

        Array.prototype.contains = function (v) {
            if (Array.isArray(v)) {
                return v.every(ai => this.includes(ai));
            } else {
                for (var i = 0; i < this.length; i++) {
                    if (this[i] === v) return true;
                }
                return false;
            }
        };

        Array.prototype.unique = function () {
            var arr = [];
            for (var i = 0; i < this.length; i++) {
                if (!arr.contains(this[i])) {
                    arr.push(this[i]);
                }
            }
            return arr;
        }
        const unzip = arr =>
            arr.reduce(
                (acc, val) => (val.forEach((v, i) => acc[i].push(v)), acc),
                Array.from({
                    length: Math.max(...arr.map(x => x.length))
                }).map(x => [])
            );

        function sendLinkMessage(link_url) {
            window.parent.postMessage(message = link_url, targetOrigin = '*');
        }
        if (window.addEventListener) {
            // For standards-compliant web browsers
            window.addEventListener("message", onMessage, false);
        } else {
            window.attachEvent("onmessage", onMessage);
        }
        // Retrieve data and begin processing
        function onMessage(event) {
            if (event && event.data && event.data.data) {

                const unzippedData = unzip(event.data.data);

                const konUnique = unzippedData[0].unique().sort();
                const alderUnique = unzippedData[1].unique().sort();
                const omradeUnique = unzippedData[2].unique().sort(function (x, y) {
                    return x == "Stockholms län" ? -1 : y == "Stockholms län" ? 1 : 0;
                });

                $('#linje_kon').empty();
                konUnique.forEach(element => {
                    $('#linje_kon').append(
                        `<option value="${element}" data-tokens="${element}">${element}</option>`)
                });
                $('#linje_kon').selectpicker('refresh');

                if (konUnique.contains(event.data.parameters.find(o => o.label == 'linje_Kön').value)) {
                    $('#linje_kon').val(event.data.parameters.find(o => o.label == 'linje_Kön').value).selectpicker(
                        'refresh');
                } else {
                    $('#linje_kon').val(konUnique).selectpicker(
                        'refresh');
                    sendMessage = {
                        'type': 'changeParameter',
                        'content': {
                            linje_Kön: konUnique
                        }
                    }
                    window.parent.postMessage(message = sendMessage, targetOrigin = '*');
                }

                $('#linje_alder').empty();
                alderUnique.forEach(element => {
                    $('#linje_alder').append(
                        `<option value="${element}" data-tokens="${element}">${element}</option>`)
                });
                $('#linje_alder').selectpicker('refresh');

                if (alderUnique.contains(event.data.parameters.find(o => o.label == 'linje_Åldersgrupp').value)) {
                    $('#linje_alder').val(event.data.parameters.find(o => o.label == 'linje_Åldersgrupp').value)
                        .selectpicker(
                            'refresh');
                } else {
                    $('#linje_alder').val(alderUnique).selectpicker(
                        'refresh');
                    sendMessage = {
                        'type': 'changeParameter',
                        'content': {
                            linje_Åldersgrupp: alderUnique
                        }
                    }
                    window.parent.postMessage(message = sendMessage, targetOrigin = '*');
                }

                $('#linje_omrade').empty();
                if (omradeUnique.length <= 40) {
                    omradeUnique.forEach(element => {
                        $('#linje_omrade').append(
                            `<option value="${element}" data-tokens="${element}" data-subtext="${omradeSubTextMap[element]}">${element}</option>`
                        )
                    });
                } else {
                    for (const [key, values] of Object.entries(allaOmrade)) {
                        $('#linje_omrade').append(
                            `<option value="${key}" data-tokens="${key}" data-subtext="${omradeSubTextMap[key]}" style = "font-weight: bold" >${key}</option>`
                        )
                        if (values.length != 0) {
                            values.forEach(element => {
                                $('#linje_omrade').append(
                                    `<option value="${element}" data-tokens="${key}"+" "+"${element}" data-subtext="kommundel">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;${element}</option>`
                                )
                            })
                        }
                    }
                }
                $('#linje_omrade').selectpicker('refresh');

                if (omradeUnique.contains(event.data.parameters.find(o => o.label == 'linje_Område').value)) {
                    $('#linje_omrade').val(event.data.parameters.find(o => o.label == 'linje_Område').value)
                        .selectpicker(
                            'refresh');
                } else {
                    $('#linje_omrade').val(omradeUnique.slice(0, 2)).selectpicker(
                        'refresh');
                    sendMessage = {
                        'type': 'changeParameter',
                        'content': {
                            linje_Område: omradeUnique.slice(0, 2)
                        }
                    }
                    window.parent.postMessage(message = sendMessage, targetOrigin = '*');
                }
            }
        }
        $('.selectpicker').on('changed.bs.select', function (e, clickedIndex, isSelected, previousValue) {
            if ($(this).val().length < 1) {
                $(this).val(previousValue);
                $(this).selectpicker('refresh');
            } else {
                parameterName = e.target.attributes['sas-parameter'].textContent;
                sendMessage = {
                    'type': 'changeParameter',
                    'content': {
                        [parameterName]: $(this).val()
                    }
                }
                window.parent.postMessage(message = sendMessage, targetOrigin = '*');
                if (['linje_Område', 'stapel_Område', 'table_Område'].includes(parameterName)) {
                    sendMessage = {
                        'type': 'defaultOmradeChanged',
                        'content': {
                            [parameterName]: $(this).val()
                        }
                    }
                    window.parent.postMessage(message = sendMessage, targetOrigin = '*');
                }
            }
        });
    </script>
</body>